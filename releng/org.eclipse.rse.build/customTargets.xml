<project name="Build specific targets and properties" default="noDefault">

	<!-- ===================================================================== -->
	<!-- Run a given ${target} on all elements being built -->
	<!-- Add on <ant> task for each top level element being built. -->
	<!-- ===================================================================== -->
	<target name="allElements">
		<ant antfile="${genericTargets}" target="${target}">
			<property name="type" value="feature" />
			<property name="id" value="org.eclipse.rse.sdk" />
		</ant>
		<ant antfile="${genericTargets}" target="${target}">
			<property name="type" value="feature" />
			<property name="id" value="org.eclipse.rse.core" />
		</ant>
		<ant antfile="${genericTargets}" target="${target}">
			<property name="type" value="feature" />
			<property name="id" value="org.eclipse.rse.local" />
		</ant>
		<ant antfile="${genericTargets}" target="${target}">
			<property name="type" value="feature" />
			<property name="id" value="org.eclipse.rse.ftp" />
		</ant>
		<ant antfile="${genericTargets}" target="${target}">
			<property name="type" value="feature" />
			<property name="id" value="org.eclipse.rse.dstore" />
		</ant>
	</target>

	<!-- ===================================================================== -->
	<!-- Targets to assemble the built elements for particular configurations  -->
	<!-- These generally call the generated assemble scripts (named in         -->
	<!-- ${assembleScriptName}) but may also add pre and post processing       -->
	<!-- Add one target for each root element and each configuration           -->
	<!-- ===================================================================== -->

	<target name="assemble.org.eclipse.rse.sdk">
		<ant antfile="${assembleScriptName}" dir="${buildDirectory}"/>
	</target>

	<target name="assemble.org.eclipse.rse.core">
		<ant antfile="${assembleScriptName}" dir="${buildDirectory}"/>
	</target>

	<target name="assemble.org.eclipse.rse.local">
		<ant antfile="${assembleScriptName}" dir="${buildDirectory}"/>
	</target>

	<target name="assemble.org.eclipse.rse.ftp">
		<ant antfile="${assembleScriptName}" dir="${buildDirectory}"/>
	</target>

	<target name="assemble.org.eclipse.rse.dstore">
		<ant antfile="${assembleScriptName}" dir="${buildDirectory}"/>
	</target>

	<!-- ===================================================================== -->
	<!-- Check out map files from correct repository -->
	<!-- Replace values for cvsRoot, package and mapVersionTag as desired. -->
	<!-- ===================================================================== -->
	<target name="getMapFiles">
		<property name="cvsRoot" value=":pserver:anonymous@dev.eclipse.org:/cvsroot/dsdp" />
		<cvs cvsRoot="${cvsRoot}"
			package="org.eclipse.tm.rse/releng/org.eclipse.rse.build"
			dest="${buildDirectory}/releng"
			tag="${mapVersionTag}"
		/>
		<copy todir="${buildDirectory}/maps">
			<mapper type="flatten"/>
			<fileset dir="${buildDirectory}/releng" includes="**/*.map"/>
		</copy>
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do before setup -->
	<!-- ===================================================================== -->
	<target name="preSetup">
		<echo message="builder = ${builder}"/>
		<echo message="builderDirectory = ${builderDirectory}"/>
		<echo message="buildProperties = ${buildProperties}"/>
		<echo message="customTargets = ${customTargets}"/>
		<echo message="genericTargets = ${genericTargets}"/>
		<echo message="buildId = ${buildId}"/>
		<echo message="buildName = ${buildName}"/>
		<echo message="buildType = ${buildType}"/>
		<echo message="buildLabel = ${buildLabel}"/>
		<echo message="archivePrefix = ${archivePrefix}"/>
		<echo message="collectingFolder = ${collectingFolder}"/>
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after setup but before starting the build proper -->
	<!-- ===================================================================== -->
	<target name="postSetup">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do before fetching the build elements -->
	<!-- ===================================================================== -->
	<target name="preFetch">
		<!-- clean up the old driver -->
		<!--	<delete includeEmptyDirs="true">-->
		<!--
		<fileset dir="${buildDirectory}\plugins" casesensitive="yes" defaultexcludes="no">
			<include name="org.eclipse.*/**" />
		</fileset>
		<fileset dir="${buildDirectory}\features" casesensitive="yes" defaultexcludes="no">
			<include name="org.eclipse.*/**" />
		</fileset>
		<fileset dir="${builddest}" casesensitive="yes" defaultexcludes="yes">
			<include name="full/eclipse/**" />
			<include name="full/Config/**" />
			<include name="lite/**" />
		</fileset>
		<fileset dir="${head}\eclipse\plugins" casesensitive="yes" defaultexcludes="yes">
			<include name="org.eclipse.*/**" />
		</fileset>
		<fileset dir="${head}\eclipse\features" casesensitive="yes" defaultexcludes="no">
			<include name="org.eclipse.*/**" />
		</fileset>
		-->
		<!--	</delete>-->
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after fetching the build elements -->
	<!-- ===================================================================== -->
	<target name="postFetch">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do before generating the build scripts. -->
	<!-- ===================================================================== -->
	<target name="preGenerate">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after generating the build scripts. -->
	<!-- ===================================================================== -->
	<target name="postGenerate">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do before running the build.xmls for the elements being built. -->
	<!-- ===================================================================== -->
	<target name="preProcess">
		<replace dir="${buildDirectory}/plugins" value="${buildId}" token="@build@">
			<include name="**/about.mappings" />
		</replace>
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after running the build.xmls for the elements being built. -->
	<!-- ===================================================================== -->
	<target name="postProcess">
		<antcall target="allElements">
			<param name="target" value="gatherLogs" />
		</antcall>
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do before running assemble. -->
	<!-- ===================================================================== -->
	<target name="preAssemble">
		<antcall target="serverruntime" />
		<antcall target="hideServerStuff" />
		<antcall target="allElements">
			<param name="target" value="gatherSources" />
		</antcall>
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after  running assemble. -->
	<!-- ===================================================================== -->
	<target name="postAssemble">
		<antcall target="revealServerStuff" />
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after the build is done. -->
	<!-- ===================================================================== -->
	<target name="postBuild">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do to test the build results -->
	<!-- ===================================================================== -->
	<target name="test">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do to publish the build results -->
	<!-- ===================================================================== -->
	<target name="publish" if="doPublish">
		<mkdir dir="${publishDirectory}" />
		<copy todir="${publishDirectory}">
			<fileset dir="${packageDirectory}" includes="*.zip" />
		</copy>
	</target>

	<!-- ===================================================================== -->
	<!-- Default target                                                        -->
	<!-- ===================================================================== -->
	<target name="noDefault">
		<echo message="You must specify a target when invoking this file" />
	</target>

	<!-- =====================================================================
	     Specialized targets to build the server runtime.           
	     ===================================================================== -->

	<target name="serverruntime">

		<property name="working" value="${buildDirectory}/${buildLabel}/rseserver"/>
		<mkdir dir="${working}" />
		<mkdir dir="${working}/jars" />

		<copy todir="${working}">
			<fileset dir="${buildDirectory}/plugins/org.eclipse.rse.services.dstore/serverruntime" includes="**" />
		</copy>

		<copy todir="${working}/jars">
			<fileset dir="${buildDirectory}/plugins/org.eclipse.dstore.core" includes="dstore_core.jar" />
			<fileset dir="${buildDirectory}/plugins/org.eclipse.dstore.extra" includes="dstore_extra_server.jar" />
			<fileset dir="${buildDirectory}/plugins/org.eclipse.rse.services" includes="clientserver.jar" />
			<fileset dir="${buildDirectory}/plugins/org.eclipse.rse.services.dstore" includes="dstore_miners.jar" />
		</copy>

		<antcall target="rseserver-os">
			<param name="os" value="aix"/>
			<param name="eol" value="lf"/>
		</antcall>
		<antcall target="rseserver-os">
			<param name="os" value="unix"/>
			<param name="eol" value="lf"/>
		</antcall>
		<antcall target="rseserver-os">
			<param name="os" value="linux"/>
			<param name="eol" value="lf"/>
		</antcall>
		<antcall target="rseserver-os">
			<param name="os" value="windows"/>
			<param name="eol" value="crlf"/>
		</antcall>

		<delete dir="${working}" />

	</target>

	<target name="rseserver-os">
		<mkdir dir="${working}/collector" />
		<copy todir="${working}/collector">
			<fileset dir="${working}/scripts/${os}" includes="*"/>
		</copy>
		<chmod perm="+x">
			<fileset dir="${working}/collector" includes="*"/>
		</chmod>
		<copy todir="${working}/collector">
			<fileset dir="${working}/data" includes="*"/>
		</copy>
		<replace file="${working}/collector/build.dat">
			<replacefilter token="@build@" value="${buildId}"/>
			<replacefilter token="@version@" value="${mapVersionTag}"/>
		</replace>
		<fixcrlf srcdir="${working}/collector" eol="${eol}" eof="asis" includes="*"/>
		<copy todir="${working}/collector">
			<fileset dir="${working}/jars" includes="*"/>
		</copy>
		<chmod perm="+x">
			<fileset dir="${working}/collector" includes="*.jar"/>
		</chmod>
		<tar destfile="${buildDirectory}/${buildLabel}/rseserver-${buildId}-${os}.tar" basedir="${working}/collector" includes="*"/>
		<zip destfile="${buildDirectory}/${buildLabel}/rseserver-${buildId}-${os}.zip" basedir="${working}/collector" includes="*"/>
		<delete dir="${working}/collector" />
	</target>

	<!-- =====================================================================
	     Specialized targets hide/reveal the server stuff so it doesn't get packaged
	     in the client.          
	     ===================================================================== -->

	<target name="hideServerStuff">
		<mkdir dir="${buildDirectory}/hidden"/>
		<move todir="${buildDirectory}/hidden">
			<fileset dir="${buildDirectory}/plugins" includes="**/*.jar" />
			<fileset dir="${buildDirectory}/plugins" includes="**/*src.zip" excludes="**/src.zip"/>
		</move>
	</target>

	<target name="revealServerStuff">
		<move todir="${buildDirectory}/plugins">
			<fileset dir="${buildDirectory}/hidden" includes="**" />
		</move>
		<delete dir="${buildDirectory}/hidden"/>
	</target>

	<!-- ===================================================================== -->
	<!-- Zip the docs                                                          -->
	<!-- ===================================================================== -->
	<target name="zipDoc">
		<zip destfile="${buildDirectory}\plugins\${docPluginID}\doc.zip" filesonly="false" defaultexcludes="true">
			<fileset dir="${buildDirectory}\plugins\${docPluginID}" defaultexcludes="true">
				<include name="**/*.gif" />
				<include name="**/*.html" />
				<include name="**/*.htm" />
				<include name="**/*.GIF" />
				<include name="**/*.HTML" />
				<include name="**/*.HTM" />
				<include name="**/*.css" />
			</fileset>
		</zip>
	</target>
	
	<target name="oldpostbuild">
		<mkdir dir="${packageDirectory}" />
		
		<property name="packageRuntimeDirectory" location="${packageDirectory}/runtime" />
		<mkdir dir="${packageRuntimeDirectory}" />
		<unzip src="${buildDirectory}/${buildLabel}/org.eclipse.rse.core-${buildId}.zip" dest="${packageRuntimeDirectory}" />
		<unzip src="${buildDirectory}/${buildLabel}/org.eclipse.rse.dstore-${buildId}.zip" dest="${packageRuntimeDirectory}" />
		<unzip src="${buildDirectory}/${buildLabel}/org.eclipse.rse.ftp-${buildId}.zip" dest="${packageRuntimeDirectory}" />
		<unzip src="${buildDirectory}/${buildLabel}/org.eclipse.rse.local-${buildId}.zip" dest="${packageRuntimeDirectory}" />
		<zip destfile="${packageDirectory}/RSE-runtime-${buildId}.zip" basedir="${packageRuntimeDirectory}" />
		<tar destfile="${packageDirectory}/RSE-runtime-${buildId}.tar" basedir="${packageRuntimeDirectory}" />
		<delete dir="$packageRuntimeDirectory}" />

		<property name="packageSDKDirectory" location="${packageDirectory}/sdk" />
		<mkdir dir="${packageSDKDirectory}" />
		<unzip src="${buildDirectory}/${buildLabel}/org.eclipse.rse.sdk-${buildId}.zip" dest="${packageSDKDirectory}" />
		<zip destfile="${packageDirectory}/RSE-SDK-${buildId}.zip" basedir="${packageSDKDirectory}" />
		<tar destfile="${packageDirectory}/RSE-SDK-${buildId}.tar" basedir="${packageSDKDirectory}" />
		<delete dir="$packageSDKDirectory}" />
		
	</target>

</project>
